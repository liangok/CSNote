如果当多个线程访问同一个可变的状态变量时没有使用合适的同步，程序就会出错，有三种方式可以修复这个问题

- 不在线程间共享改变量
- 将状态变量改为不可变的变量
- 再访问状态变量时使用同步

Java语言并没有强制要求将状态都封装在类中，开发人员完全可以将状态保存在某个公开的域（甚至公开的静态域）中，或者提供一个对内部对象的公开引用。然而程序的封装性越好，就越容易实现程序的线程安全性，并且代码的维护人员也越容易保持这种方式。

> 当设计线程安全的类时，良好的面对对象技术，不可修改性，以及明晰的不变性规范都能起到一定的帮助作用。

有时候，面向对象那个中的抽象和封装性会降低程序的性能，但在编程中，正确的做法是首先使代码可以运行，然后再提高代码的速度。

注意，完全由线程安全类构成的程序不一定是线程安全的，而线程安全类中也可以包含非线程安全的类。



### 什么是线程安全

#### 正确性

正确性的含义是，某个类的行为与其规范完全一致。在良好的规范中通常会定义各种不变性条件来约束对象的状态，以及定义各种后验条件来描述对象操作的结果



#### 线程安全

当多个线程访问某个类时，这个类始终可以表现出正确的行为，那么就称这个类是线程安全的。

> 当多个线程访问某个类时，不管运行环境采用何种调度方式或者这些线程将如何交替执行，并且在主调代码中不需要任何额外的同步或协同，这个类都能表现出正确的行为，那么就称这个类是线程安全的。

#### 一个无状态的类是安全的

#### 原子性

value++看上去像是一个操作，但它实际上包含三个独立的操作：读取value， 将value加1，将计算结果写入value



这种由于执行时序而出现不正确的结果叫竟态条件

##### 竟态条件

当某个计算的正确性取决于多个线程的交替执行顺序时，就会发生竟态条件，换句话说就是正确的结果要取决于运气。最常见的竟态条件就是“先检查后执行”操作，通过一个可能失效的观测结果来决定下一步的动作。

